# presentation

!SLIDE left

# Test-driving Chef cookbooks
## Using ChefSpec and Librarian-Chef

abiyani@lytro.com
https://github.com/Lytro/teaching_chef_cookbooks

!SLIDE left

## What is Chef?

Chef treats infrastructure as code
* maintainable
* testable
* scalable
* a simple-ish DSL on top of Ruby

!SLIDE left

## So what's a cookbook?

Cookbooks are like libraries
* they contain code that accomplishes some specific goal, like installing Apache2 or Git.
* http://community.opscode.com/cookbooks

!SLIDE left

## Here's what's inside a stock cookbook:

<figure>
```shell
  └── my_cookbook/
    ├── attributes/
    │   └── default.rb
    ├── definitions/
    ├── files/
    │   └── default/
    ├── libraries/
    ├── providers/
    ├── recipes/
    │   └── default.rb
    ├── resources/
    ├── templates/
    ├── metadata.rb
    └── README.md
```
</figure>

!SLIDE left

## My cookbooks have a couple of additions:

<figure>
```shell
  └── my_cookbook
    ├── spec/
    │   ├── spec_helper.rb
    │   └── default_spec.rb
    ├── Cheffile
    ├── Cheffile.lock
    ├── Gemfile
    └── Gemfile.lock
```
</figure>

* Cheffile is a part of Librarian-Chef; it's very similar to a Gemfile
* specs are a part of ChefSpec (which is built on RSpec)

I have a template setup here: https://github.com/Lytro/chef_cookbook_template

!SLIDE left

## What it all means
1. **Recipes** are the meat of a cookbook. They **contain the code that gets executed**.
2. **Attributes** contain **variables** that can get overridden by people using the cookbook, or that vary depending on the OS.
3. **Definitions** are basically contain **functions** that are used across recipes.
4. **Libraries** contain generic Ruby. **Classes or modules** can be defined in here and used across recipes/definitions/whatever.
5. **Providers** know how to accomplish certain goals for different OSes. An example of a "goal" **might be creating a directory or downloading a file** from the web.
6. **Resources** are simply **a specific provider**. For example, `directory` is a resource that creates a directory; it is implemented via providers.

!SLIDE left

## What it all means - continued
7. **Files** can be **copied to the target system**, and are sorted in subdirectories by OS
8. **Templates** are **files that use .erb** to inject ruby variables, usually from attributes.
9. **Metadata** simply **contains information about the cookbook** that Chef uses for information like dependencies and which OSes the cookbook supports.

* For the most part you can ignore `libraries`, `providers`, and `resources` (you'll rarely need them, and I won't be explaining them because I haven't used them).*
* I use `files` and `templates` frequently but not always.
* `recipes` are mandatory, and `attributes` are pretty much always necessary.

<sub>* http://wiki.opscode.com/display/chef/Introduction+to+Cookbooks+and+More</sub>

!SLIDE left

## Let's dive in: `metadata.rb`

<figure>
```ruby
name             "Cookbook Name" # Optional, if omitted then is inferred
                                 # from the name of the directory
maintainer       "Your Name"
maintainer_email "your@email.com"
license          "Apache 2.0"
description      "Installs/Configures cookbook_name"
long_description IO.read(File.join(File.dirname(__FILE__), 'README.md'))
version          "0.1.0"

depends          "some_other_cookbook", "> 0.1.0"
depends          "another_cookbook", "> 0.1.5"
supports         "Ubuntu", "> 10.04.4"
```
</figure>

Librarian-Chef pulls in dependent cookbooks through the "depends" listing.
 * You cannot target a git repo through the metadata (instead, use the Cheffile).

<sub>http://wiki.opscode.com/display/chef/Metadata</sub>

!SLIDE left

## `attributes/default.rb`

<figure>
```ruby
default[:cookbook_name][:variable]
default["cookbook_name"]["variable"]

override[:something][:something_else]
```
</figure>

Attributes are accessed with `node[:foo]` or `node["foo"]` or `node.foo`.

Precedence, from low to high:
1. default attributes applied in an attributes file
2. default attributes applied in an environment
3. default attributes applied in a role
4. default attributes applied on a node directly in a recipe
5. normal or set attributes applied in an attributes file
6. normal or set attributes applied on a node directly in a recipe
7. override attributes applied in an attributes file
8. override attributes applied in a role
9. override attributes applied in an environment
10. override attributes applied on a node directly in a recipe
11. automatic attributes generated by Ohai*

<sub>http://wiki.opscode.com/display/chef/Attributes</sub>

<sub>* Ohai is a gem that Chef depends on. It profiles your system and generates attributes like `node[:language][:ruby][:gems_dir]`. More on it in [teaching_chef_repos](https://github.com/Lytro/teaching_chef_repos).</sub>

!SLIDE left

## `Cheffile`

<figure>
```ruby
#!/usr/bin/env ruby
#^syntax detection

site 'http://community.opscode.com/api/v1'

# cookbook 'chef-client'

# cookbook 'apache2', '>= 1.0.0'

# cookbook 'rvm',
#   :git => 'https://github.com/fnichol/chef-rvm'

# cookbook 'postgresql',
#   :git => 'https://github.com/findsyou/cookbooks',
#   :ref => 'postgresql-improvements'
```
</figure>

* `librarian-chef install` will install cookbooks to `cookbooks/`
* `librarian-chef update [cookbook]` will update the given cookbook. If no cookbook is passed, then it updates all cookbooks and dependencies.
* `.gitignore` should contain `cookbooks/` and `tmp/`

<sub>If a cookbook `foo` depends on cookbook `baz` and you want to pull `baz` from a Github repo, then specify it here. Otherwise, dependent cookbooks do not need to be mentioned in the Cheffile.</sub>
